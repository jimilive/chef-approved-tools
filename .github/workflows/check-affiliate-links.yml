name: Check All Affiliate Links

# Run daily at 6 AM Pacific (2 PM UTC / 14:00 UTC)
on:
  schedule:
    - cron: '0 14 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-links:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Extract All Affiliate Links from Supabase
        id: extract
        run: |
          # Create a script to fetch affiliate links from Supabase
          # Uses public Supabase credentials (safe to hardcode since they're public)
          cat > fetch-links.mjs << 'SCRIPT'
          import { createClient } from '@supabase/supabase-js'
          import { writeFileSync } from 'fs'

          // Public Supabase credentials (these are safe to expose - they're in the client-side code)
          const SUPABASE_URL = 'https://hxvlbhphozxjmkszxjwj.supabase.co'
          const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4dmxiaHBob3p4am1rc3p4andqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNTA5NjUsImV4cCI6MjA3NjgyNjk2NX0.1RC_AJNa9JhyaxuXhvKlw0eDwPwMuOfwfppXZ6Y2fVM'

          const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

          const { data, error } = await supabase
            .from('products')
            .select('slug, name, affiliate_links')

          if (error) {
            console.error('Error fetching products:', error)
            process.exit(1)
          }

          // Extract ALL affiliate links with product names and vendor info
          const linksData = []
          data.forEach(product => {
            if (product.affiliate_links) {
              product.affiliate_links.forEach(link => {
                if (link.url) {
                  linksData.push({
                    url: link.url,
                    product: product.name,
                    vendor: link.vendor || 'unknown',
                    tag: link.tag || null
                  })
                }
              })
            }
          })

          // Write links data to JSON file for structured access
          writeFileSync('/tmp/links-data.json', JSON.stringify(linksData, null, 2))

          // Count by vendor
          const vendorCounts = {}
          linksData.forEach(link => {
            vendorCounts[link.vendor] = (vendorCounts[link.vendor] || 0) + 1
          })

          console.log(`Found ${linksData.length} total affiliate links from ${data.length} products`)
          console.log('Breakdown by vendor:')
          Object.entries(vendorCounts).forEach(([vendor, count]) => {
            console.log(`  ${vendor}: ${count} links`)
          })
          SCRIPT

          node fetch-links.mjs

          # Set the current date/time as an output
          echo "check_date=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Test All Links with Browser Headers
        id: test
        run: |
          set +e
          broken_links=""
          working_count=0
          broken_count=0
          vendor_summary=""

          # Track counts by vendor
          declare -A vendor_working
          declare -A vendor_broken

          # Read all links data
          links_json=$(cat /tmp/links-data.json)
          total_links=$(echo "$links_json" | jq '. | length')

          echo "Testing $total_links affiliate links..."
          echo ""

          # Process each link
          for i in $(seq 0 $((total_links - 1))); do
            link_data=$(echo "$links_json" | jq -r ".[$i]")
            url=$(echo "$link_data" | jq -r '.url')
            product=$(echo "$link_data" | jq -r '.product')
            vendor=$(echo "$link_data" | jq -r '.vendor')
            tag=$(echo "$link_data" | jq -r '.tag')

            # Build display label
            if [ "$tag" != "null" ] && [ -n "$tag" ]; then
              display_label="$product [$vendor] (variant: $tag)"
            else
              display_label="$product [$vendor]"
            fi

            # Test with proper browser headers to avoid bot detection
            response=$(curl -s -o /dev/null -w "%{http_code}|%{url_effective}" -L "$url" \
              -H "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
              -H "Accept-Language: en-US,en;q=0.9" \
              --max-time 15)

            status=$(echo "$response" | cut -d'|' -f1)
            final_url=$(echo "$response" | cut -d'|' -f2)

            # Determine if link is broken based on vendor
            is_broken=false
            error_msg=""

            if [ "$status" -eq 200 ] || ([ "$status" -ge 300 ] && [ "$status" -lt 400 ]); then
              # Check vendor-specific failure patterns
              case "$vendor" in
                amazon)
                  # Amazon: flag if redirects to homepage or generic pages
                  if [[ "$final_url" =~ ^https?://www\.amazon\.com/?(\?|$) ]] || \
                     [[ "$final_url" =~ ^https?://www\.amazon\.com/ref= ]] || \
                     [[ "$final_url" == "https://www.amazon.com/" ]]; then
                    is_broken=true
                    error_msg="REDIRECTS TO AMAZON HOMEPAGE (broken ASIN)"
                  fi
                  ;;
                vitamix_cj|zwilling_cj|kitchenaid|henckels)
                  # CJ Network links: basic validation that it doesn't redirect to error page
                  if [[ "$final_url" =~ (404|error|not-found) ]]; then
                    is_broken=true
                    error_msg="REDIRECTS TO ERROR PAGE"
                  fi
                  ;;
              esac
            else
              # Bad HTTP status
              is_broken=true
              error_msg="HTTP $status"
            fi

            # Record result
            if [ "$is_broken" = true ]; then
              echo "âŒ $display_label"
              echo "   URL: $url"
              echo "   Error: $error_msg"
              echo "   Final: $final_url"
              echo ""
              broken_links="$broken_links\n- **$display_label**\n  $url\n  Error: $error_msg"
              ((broken_count++))
              vendor_broken[$vendor]=$((${vendor_broken[$vendor]:-0} + 1))
            else
              echo "âœ… $display_label"
              ((working_count++))
              vendor_working[$vendor]=$((${vendor_working[$vendor]:-0} + 1))
            fi

            # Rate limit: wait 1 second between checks
            sleep 1
          done

          # Build vendor summary
          echo ""
          echo "Summary by vendor:"
          for vendor in "${!vendor_working[@]}" "${!vendor_broken[@]}"; do
            working=${vendor_working[$vendor]:-0}
            broken=${vendor_broken[$vendor]:-0}
            total=$((working + broken))
            vendor_summary="$vendor_summary\n$vendor: $working/$total working"
          done

          total_count=$((working_count + broken_count))
          echo "working_count=$working_count" >> $GITHUB_OUTPUT
          echo "broken_count=$broken_count" >> $GITHUB_OUTPUT
          echo "total_count=$total_count" >> $GITHUB_OUTPUT
          echo "vendor_summary<<EOF" >> $GITHUB_OUTPUT
          echo -e "$vendor_summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "broken_links<<EOF" >> $GITHUB_OUTPUT
          echo -e "$broken_links" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Email if Links are Broken
        if: steps.test.outputs.broken_count != '0'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: 'ðŸš¨ Chef Approved Tools - ${{ steps.test.outputs.broken_count }} Broken Affiliate Link(s) Detected'
          to: scottdbradley@gmail.com
          from: Chef Approved Tools <${{ secrets.GMAIL_USERNAME }}>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background-color: #dc2626; color: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
                .header h1 { margin: 0; font-size: 24px; }
                .stats { background-color: #f3f4f6; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
                .broken-links { background-color: #fef2f2; border-left: 4px solid #dc2626; padding: 15px; margin-bottom: 20px; }
                .action-items { background-color: #eff6ff; border-left: 4px solid #2563eb; padding: 15px; margin-bottom: 20px; }
                .action-items ol { margin: 10px 0; padding-left: 20px; }
                .footer { color: #6b7280; font-size: 14px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
                code { background-color: #f3f4f6; padding: 2px 6px; border-radius: 3px; font-family: monospace; }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>ðŸš¨ Broken Affiliate Links Detected</h1>
              </div>

              <div class="stats">
                <strong>Status:</strong> ${{ steps.test.outputs.broken_count }} broken link(s) found out of ${{ steps.test.outputs.total_count }} total<br>
                <strong>Site:</strong> www.chefapprovedtools.com<br>
                <strong>Check Date:</strong> ${{ steps.extract.outputs.check_date }}<br>
                <strong>Vendors Checked:</strong> Amazon, Vitamix, Zwilling, KitchenAid, and others
              </div>

              <div class="stats">
                <strong>Breakdown by Vendor:</strong><br>
                <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">${{ steps.test.outputs.vendor_summary }}</pre>
              </div>

              <div class="broken-links">
                <h2 style="margin-top: 0; color: #dc2626;">Broken Links:</h2>
                <pre style="white-space: pre-wrap; word-wrap: break-word;">${{ steps.test.outputs.broken_links }}</pre>
              </div>

              <div class="action-items">
                <h2 style="margin-top: 0; color: #2563eb;">Action Required:</h2>
                <ol>
                  <li>Log into the appropriate affiliate program:
                    <ul>
                      <li>Amazon: <a href="https://affiliate-program.amazon.com">affiliate-program.amazon.com</a></li>
                      <li>CJ Network (Vitamix, Zwilling, etc): <a href="https://www.cj.com">cj.com</a></li>
                    </ul>
                  </li>
                  <li>Verify these products still exist and are available</li>
                  <li>Generate fresh affiliate links if needed</li>
                  <li>Update links in Supabase database</li>
                  <li>Test the updated links manually before deploying</li>
                </ol>
                <p><strong>Common Issues:</strong></p>
                <ul style="margin: 5px 0; padding-left: 20px;">
                  <li><strong>AMAZON HOMEPAGE</strong> - The ASIN is invalid/discontinued. Create a new affiliate link.</li>
                  <li><strong>HTTP 404/410</strong> - Product no longer available. Find replacement product.</li>
                  <li><strong>HTTP 403/429</strong> - Rate limiting. Links are likely fine, will recheck tomorrow.</li>
                  <li><strong>CJ ERROR PAGE</strong> - Deep link expired or product removed from advertiser catalog.</li>
                </ul>
              </div>

              <div class="footer">
                <p><strong>Automated Check Details:</strong></p>
                <ul style="margin: 5px 0; padding-left: 20px;">
                  <li>This check runs daily at 6 AM Pacific (2 PM UTC)</li>
                  <li>Fetches ALL affiliate links from Supabase (Amazon, Vitamix, Zwilling, KitchenAid, variants, comparison products)</li>
                  <li>Uses proper browser headers to avoid bot detection</li>
                  <li>Tests HTTP status codes AND verifies final redirect URL</li>
                  <li>Vendor-specific validation (Amazon homepage check, CJ error page detection)</li>
                </ul>
                <p style="margin-top: 15px;"><em>This email was sent automatically by the Chef Approved Tools affiliate link checker workflow.</em></p>
              </div>
            </body>
            </html>

      - name: Send Success Email
        if: steps.test.outputs.broken_count == '0'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_PASSWORD }}
          subject: 'âœ… Chef Approved Tools - All Affiliate Links Working'
          to: scottdbradley@gmail.com
          from: Chef Approved Tools <${{ secrets.GMAIL_USERNAME }}>
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background-color: #059669; color: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
                .header h1 { margin: 0; font-size: 24px; }
                .stats { background-color: #f0fdf4; border-left: 4px solid #059669; padding: 15px; margin-bottom: 20px; }
                .footer { color: #6b7280; font-size: 14px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>âœ… All Affiliate Links Working</h1>
              </div>

              <div class="stats">
                <strong>Status:</strong> All ${{ steps.test.outputs.working_count }} affiliate links are working correctly<br>
                <strong>Site:</strong> www.chefapprovedtools.com<br>
                <strong>Check Date:</strong> ${{ steps.extract.outputs.check_date }}<br>
                <strong>Vendors Checked:</strong> Amazon, Vitamix, Zwilling, KitchenAid, and others
              </div>

              <div class="stats">
                <strong>Breakdown by Vendor:</strong><br>
                <pre style="white-space: pre-wrap; font-family: monospace; font-size: 12px;">${{ steps.test.outputs.vendor_summary }}</pre>
              </div>

              <p>Great news! All affiliate links on your site are working properly, including Amazon, CJ Network (Vitamix, Zwilling, KitchenAid), size variants, and comparison products.</p>

              <div class="footer">
                <p><em>This email was sent automatically by the Chef Approved Tools affiliate link checker workflow running daily at 6 AM Pacific.</em></p>
              </div>
            </body>
            </html>

      - name: Summary
        run: |
          echo "## Affiliate Link Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Working: ${{ steps.test.outputs.working_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Broken: ${{ steps.test.outputs.broken_count }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.test.outputs.broken_count }}" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Broken Links:" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.test.outputs.broken_links }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“§ An email notification has been sent to scottdbradley@gmail.com" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All affiliate links are working correctly!" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“§ Success notification sent to scottdbradley@gmail.com" >> $GITHUB_STEP_SUMMARY
          fi
